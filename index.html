<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ajuda EQS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(to right, #e0eafc, #cfdef3);
    }
    .fade-out {
      transition: opacity 0.5s ease-out;
      opacity: 0;
    }
    .popup-highlight {
      background-color: #fff9c4;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col justify-between p-4 sm:p-6">

<div id="loginContainer" class="flex-grow flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">üîê Login</h1>
    <input id="usuario" type="text" placeholder="Usu√°rio" class="w-full mb-4 px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <div class="relative mb-4">
      <input id="senha" type="password" placeholder="Senha" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button type="button" onclick="toggleSenha()" class="absolute right-3 top-3 text-sm text-blue-600 hover:underline">Mostrar</button>
    </div>
    <div class="flex items-center mb-4">
      <input id="lembrar" type="checkbox" class="mr-2">
      <label for="lembrar" class="text-sm">Manter-me logado por 10 dias</label>
    </div>
    <button onclick="fazerLogin()" class="w-full bg-blue-600 hover:bg-blue-700 transition transform hover:scale-105 text-white py-3 rounded-lg font-bold">
      Entrar
    </button>
    <div id="loginErro" class="mt-4 text-red-500 text-center"></div>
  </div>
</div>

<div id="appContainer" class="hidden flex flex-col items-center">
  <h1 class="text-4xl font-bold mb-6 text-center text-black">Ajuda EQS</h1>
  <div class="w-full max-w-md">
    <input id="termoBusca" type="text" oninput="sugerirNomes()" placeholder="Digite o nome do site ou cidade" class="w-full mb-4 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
    <div id="sugestoes" class="w-full mb-2 shadow rounded bg-white"></div>
    <button id="buscarBtn" onclick="buscar()" class="w-full mb-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
      Buscar
    </button>
    <div id="resultados" class="w-full"></div>
  </div>
</div>

<footer class="text-center text-gray-500 text-xs py-4">
  Desenvolvido por Rodrigo Ribero | Acessos: <span id="contadorAcessos">0</span>
</footer>

<script>
let dadosPlanilha = [];
const URL_PLANILHA_USUARIOS = 'https://opensheet.elk.sh/1CqBE9J8S1muMBKT4v7x3jmZ4m4aecUaXOah_tWPaN1s/usuarios';
const URL_PLANILHA_DADOS = 'https://opensheet.elk.sh/1CqBE9J8S1muMBKT4v7x3jmZ4m4aecUaXOah_tWPaN1s/bd_infra';

function removerAcentos(str) {
  return str.normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "");
}

async function fazerLogin() {
  const usuario = document.getElementById("usuario").value.trim().toLowerCase();
  const senha = document.getElementById("senha").value.trim();
  const lembrar = document.getElementById("lembrar").checked;
  const erroDiv = document.getElementById("loginErro");

  try {
    const resposta = await fetch(URL_PLANILHA_USUARIOS);
    const usuarios = await resposta.json();
    const encontrado = usuarios.find(u => (u.usuario || '').toLowerCase() === usuario && (u.senha || '') === senha);

    if (encontrado) {
      document.getElementById("loginContainer").classList.add("hidden");
      document.getElementById("appContainer").classList.remove("hidden");
      if (lembrar) {
        const agora = new Date();
        agora.setDate(agora.getDate() + 10);
        localStorage.setItem("usuarioLogado", JSON.stringify({ usuario, expira: agora.getTime() }));
      }
      incrementarAcessos();
      await carregarDados();
    } else {
      erroDiv.textContent = "Usu√°rio ou senha incorretos.";
    }
  } catch (erro) {
    console.error("Erro ao fazer login:", erro);
    erroDiv.textContent = "Erro ao verificar login.";
  }
}

function toggleSenha() {
  const senhaInput = document.getElementById("senha");
  if (senhaInput.type === "password") {
    senhaInput.type = "text";
    event.target.textContent = "Ocultar";
  } else {
    senhaInput.type = "password";
    event.target.textContent = "Mostrar";
  }
}

async function carregarDados() {
  try {
    const resposta = await fetch(URL_PLANILHA_DADOS);
    dadosPlanilha = await resposta.json();
  } catch (erro) {
    console.error('Erro ao carregar dados:', erro);
  }
}

function incrementarAcessos() {
  let acessos = localStorage.getItem("contadorAcessos") || 0;
  acessos++;
  localStorage.setItem("contadorAcessos", acessos);
  document.getElementById("contadorAcessos").innerText = acessos;
}

function copiarTexto(texto) {
  navigator.clipboard.writeText(texto)
    .then(() => alert('UC copiado!'))
    .catch(err => console.error('Erro ao copiar:', err));
}

function buscar() {
  const termo = removerAcentos(document.getElementById("termoBusca").value.trim().toLowerCase());
  const resultadosDiv = document.getElementById("resultados");

  if (!termo) {
    resultadosDiv.innerHTML = '<p class="text-red-500">Por favor, digite um site ou cidade.</p>';
    return;
  }

  const resultadosFiltrados = dadosPlanilha.filter(linha =>
    (linha.SITE && removerAcentos(linha.SITE.toLowerCase()).includes(termo)) ||
    (linha.CIDADE && removerAcentos(linha.CIDADE.toLowerCase()).startsWith(termo))
  );

  if (resultadosFiltrados.length > 0) {
    resultadosDiv.innerHTML = resultadosFiltrados.map(resultado => `
      <div class="bg-white p-4 rounded-lg shadow mb-4">
        <p><strong>Site:</strong> ${resultado.SITE}</p>
        <p class="flex items-center gap-2"><strong>UC:</strong> ${resultado.UC}
          <button onclick="copiarTexto('${resultado.UC}')" class="ml-2 p-1 rounded hover:bg-gray-200">üìã</button>
        </p>
        <p><strong>Medidor:</strong> ${resultado.MEDIDOR}</p>
        <p><strong>Concession√°ria:</strong> ${resultado.CONCESSIONARIA}</p>
        <p><strong>Cidade:</strong> ${resultado.CIDADE}</p>
        ${resultado.LATITUDE && resultado.LONGITUDE ? `<div class="flex justify-center mt-4">
          <a href="https://www.google.com/maps/search/?api=1&query=${resultado.LATITUDE},${resultado.LONGITUDE}" target="_blank" class="bg-blue-600 hover:bg-blue-700 transition transform hover:scale-110 text-white text-sm py-2 px-6 rounded-full shadow-md">
            üìç Estou Aqui
          </a>
        </div>` : ''}
      </div>
    `).join('');
  } else {
    resultadosDiv.innerHTML = '<p class="text-yellow-600">Nenhum resultado encontrado.</p>';
  }
}

function sugerirNomes() {
  const termo = removerAcentos(document.getElementById("termoBusca").value.trim().toLowerCase());
  const sugestoesDiv = document.getElementById("sugestoes");
  if (!termo) {
    sugestoesDiv.innerHTML = "";
    return;
  }

  const sugestoes = dadosPlanilha.filter(linha =>
    (linha.SITE && removerAcentos(linha.SITE.toLowerCase()).includes(termo)) ||
    (linha.CIDADE && removerAcentos(linha.CIDADE.toLowerCase()).startsWith(termo))
  ).slice(0, 5);

  if (sugestoes.length > 0) {
    sugestoesDiv.innerHTML = sugestoes.map(item => `
      <div class="p-2 hover:bg-gray-200 cursor-pointer rounded ${item.POPUP ? 'popup-highlight' : ''}" onclick="selecionarSugestao('${item.SITE || item.CIDADE}')">
        ${item.SITE || item.CIDADE}
      </div>
    `).join('');
  } else {
    sugestoesDiv.innerHTML = "";
  }
}

function selecionarSugestao(valor) {
  document.getElementById('termoBusca').value = valor;
  const sugestoesDiv = document.getElementById('sugestoes');
  sugestoesDiv.classList.add('fade-out');
  setTimeout(() => {
    sugestoesDiv.innerHTML = "";
    sugestoesDiv.classList.remove('fade-out');
  }, 500);
  buscar();
}
</script>

</body>
</html>
